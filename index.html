<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Cast To TV - Screen Mirroring</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            overflow: hidden;
        }
        #video-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }
        #screenImage {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        #status {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-family: Arial, sans-serif;
            font-size: 18px;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
        }
        #fps {
            position: absolute;
            top: 60px;
            left: 20px;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            background: rgba(0,0,0,0.7);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="status">Initializing...</div>
    <div id="fps">FPS: 0</div>
    <div id="video-container">
        <img id="screenImage" alt="Screen Mirror">
    </div>

    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <script>
        const context = cast.framework.CastReceiverContext.getInstance();
        const statusEl = document.getElementById('status');
        const fpsEl = document.getElementById('fps');
        const screenImage = document.getElementById('screenImage');

        let frameCount = 0;
        let lastTime = Date.now();
        let lastFrameTime = Date.now();

        // Audio playback - OPTIMIZED
        let audioContext = null;
        let nextAudioTime = 0;
        const AUDIO_BUFFER_TARGET = 0.1; // 100ms audio buffer

        const NAMESPACE = 'urn:x-cast:com.xxx.screenmirroring';

        console.log('=== Cast Receiver Initializing ===');
        console.log('Namespace:', NAMESPACE);

        // Initialize Cast Receiver
        const castReceiverOptions = new cast.framework.CastReceiverOptions();
        castReceiverOptions.disableIdleTimeout = true;
        castReceiverOptions.maxInactivity = 3600;

        // Initialize Web Audio API
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                nextAudioTime = audioContext.currentTime;
                console.log('Audio context initialized. Sample rate:', audioContext.sampleRate);
            }
        }

        // Handle frame messages from Android app
        context.addCustomMessageListener(NAMESPACE, function(customEvent) {
            try {
                const data = customEvent.data;

                if (data.type === 'frame') {
                    handleFrame(data);
                } else if (data.type === 'audio') {
                    handleAudio(data);
                }
            } catch (error) {
                console.error('Error processing message:', error);
            }
        });

        function handleFrame(data) {
            try {
                // OPTIMIZATION: Direct assignment, no extra conversions
                screenImage.src = 'data:image/jpeg;base64,' + data.data;

                frameCount++;
                lastFrameTime = Date.now();

                if (frameCount === 1) {
                    statusEl.textContent = '✓ Screen Mirroring Active';
                }
            } catch (error) {
                console.error('Error displaying frame:', error);
            }
        }

        function handleAudio(data) {
            try {
                if (!audioContext) {
                    initAudio();
                }

                // OPTIMIZATION: Faster audio decoding
                const base64Audio = data.data;
                const binaryString = atob(base64Audio);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }

                const sampleRate = data.sampleRate || 44100;
                const channels = data.channels || 1; // MONO now
                const pcmData = new Int16Array(bytes.buffer);

                // Create audio buffer
                const audioBuffer = audioContext.createBuffer(channels, pcmData.length / channels, sampleRate);

                // Convert PCM16 to Float32
                for (let channel = 0; channel < channels; channel++) {
                    const channelData = audioBuffer.getChannelData(channel);
                    const stride = channels;
                    for (let i = 0; i < channelData.length; i++) {
                        channelData[i] = pcmData[i * stride + channel] / 32768.0;
                    }
                }

                // OPTIMIZATION: Better audio scheduling to prevent gaps
                const source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioContext.destination);

                const currentTime = audioContext.currentTime;

                // Schedule with small buffer to prevent gaps
                if (nextAudioTime < currentTime + AUDIO_BUFFER_TARGET) {
                    nextAudioTime = currentTime + AUDIO_BUFFER_TARGET;
                }

                source.start(nextAudioTime);
                nextAudioTime += audioBuffer.duration;

            } catch (error) {
                console.error('Error processing audio:', error);
            }
        }

        // FPS counter
        function startFPSCounter() {
            setInterval(() => {
                const now = Date.now();
                const elapsed = (now - lastTime) / 1000;
                const fps = Math.round(frameCount / elapsed);

                const timeSinceLastFrame = now - lastFrameTime;
                if (timeSinceLastFrame > 2000) {
                    statusEl.textContent = '⚠ No frames received';
                    fpsEl.textContent = 'FPS: 0';
                } else {
                    fpsEl.textContent = 'FPS: ' + fps;
                }

                frameCount = 0;
                lastTime = now;
            }, 1000);
        }

        // System events
        context.addEventListener(
            cast.framework.system.EventType.SENDER_CONNECTED,
            function(event) {
                console.log('Sender connected:', event.senderId);
                statusEl.textContent = 'Device Connected - Waiting for stream...';
                initAudio();
                startFPSCounter();
            }
        );

        context.addEventListener(
            cast.framework.system.EventType.SENDER_DISCONNECTED,
            function(event) {
                console.log('Sender disconnected');
                statusEl.textContent = 'Device Disconnected';
                fpsEl.textContent = 'FPS: 0';
                screenImage.src = '';
                frameCount = 0;

                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }
            }
        );

        context.addEventListener(
            cast.framework.system.EventType.READY,
            function(event) {
                console.log('Receiver ready');
                statusEl.textContent = 'Ready - Waiting for connection...';
            }
        );

        context.addEventListener(
            cast.framework.system.EventType.ERROR,
            function(event) {
                console.error('Cast Receiver Error:', event);
                statusEl.textContent = 'Error: ' + event.error;
            }
        );

        // Start receiver
        try {
            context.start(castReceiverOptions);
            console.log('=== Cast receiver started successfully ===');
        } catch (error) {
            console.error('=== FAILED to start Cast receiver ===', error);
            statusEl.textContent = 'FAILED TO START: ' + error.message;
            document.body.style.backgroundColor = 'red';
        }
    </script>
</body>
</html>
